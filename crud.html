<!-- crud.html - Kode Lengkap dengan URL GAS Baru -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Data - UGC Prompt Generator</title>
  <link rel="stylesheet" href="style.css"> <!-- Pakai CSS yang sama -->
</head>
<body>
  <div class="wrap">
    <div class="card">
      <span class="pill">ğŸ—‚ï¸ Manage Data â€¢ CRUD</span>
      <h1>ğŸš€ Manage Data (CRUD)</h1>
      <p class="sub">Tambah, edit, atau hapus data ID Karakter, dll. Data disimpan di Google Sheets. Klik Load Data untuk mulai.</p>

      <!-- Menu: Pilih Mode -->
      <div class="grid">
        <div>
          <label>ğŸ“‹ Mode</label>
          <select id="mode" onchange="switchMode()">
            <option value="add">Input Data Baru</option>
            <option value="edit">Pilih ID Tersimpan untuk Edit</option>
          </select>
          <div class="hint">
            Pilih "Input Data Baru" untuk tambah data. Pilih "Pilih ID Tersimpan" untuk edit data existing.
          </div>
        </div>
        <div id="select_existing" class="hidden">
          <label>ğŸ†” Pilih ID Karakter Tersimpan</label>
          <select id="existing_select" onchange="loadToForm()">
            <option value="">Pilih ID...</option>
            <!-- Akan diisi otomatis dari loadData -->
          </select>
          <div class="hint">
            Pilih ID dari list tersimpan, lalu edit di form bawah.
          </div>
        </div>
      </div>

      <!-- Form Add/Edit -->
      <div class="hr"></div>
      <div class="grid">
        <div>
          <label>ğŸ†” ID Karakter</label>
          <input id="char_id" placeholder="contoh: CHAR-ID: ASTRA-01" />
        </div>
        <div>
          <label>ğŸ‘¤ Atribut Fisik</label>
          <input id="attr_fisik" placeholder="contoh: Wajah oval, mata hijau, rambut perak" />
        </div>
        <div>
          <label>ğŸ‘• ID Pakaian</label>
          <input id="cloth_id" placeholder="contoh: OUTFIT-ID: ASTRA-CASUAL-01" />
        </div>
        <div>
          <label>ğŸ¤ ID Suara</label>
          <input id="voice_id" placeholder="contoh: VOICE-ID: ALTO-MYSTERY-01" />
        </div>
        <div>
          <label>ğŸŒ ID Gaya Visual</label>
          <input id="style_id" placeholder="contoh: STYLE-ID: NEO-JAKARTA-RAINY-01" />
        </div>
        <div>
          <button class="btn" id="add_btn" onclick="addData()">â• Add Data Baru</button>
          <button class="btn alt" id="update_btn" onclick="updateData()" style="display:none;">âœï¸ Update Data</button>
          <button class="btn ghost" onclick="loadData()">ğŸ“¥ Load Data</button>
          <button class="btn ghost" onclick="clearForm()">ğŸ—‘ï¸ Clear Form</button>
        </div>
      </div>

      <!-- List Data -->
      <div class="hr"></div>
      <label>ğŸ“‹ List Data dari Google Sheets</label>
      <div id="data_list" class="example">
        <!-- Data akan muncul di sini -->
      </div>

      <!-- Link Kembali ke Halaman Utama -->
      <div class="hr"></div>
      <p class="muted">Selesai manage data? <a href="index.html">Kembali ke Generator Prompt</a></p>
    </div>
  </div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwmDzp1ifdkngq3e24lz_w1r5ZlnKH2yQtck_TFS8P_e7gQJI4fi4U1b6t15PTKFS6GiA/exec';

let data = [];
let editIndex = -1;

function switchMode(){
  const mode = document.getElementById('mode').value;
  const selectDiv = document.getElementById('select_existing');
  const addBtn = document.getElementById('add_btn');
  const updateBtn = document.getElementById('update_btn');
  if(mode === 'edit'){
    selectDiv.classList.remove('hidden');
    addBtn.style.display = 'none';
    updateBtn.style.display = 'inline-block';
    updateExistingSelect();
  } else {
    selectDiv.classList.add('hidden');
    addBtn.style.display = 'inline-block';
    updateBtn.style.display = 'none';
    clearForm();
  }
}

function updateExistingSelect(){
  const select = document.getElementById('existing_select');
  select.innerHTML = '<option value="">Pilih ID...</option>';
  data.forEach((item, index) => {
    if(item.char_id){
      select.innerHTML += `<option value="${index}">${item.char_id}</option>`;
    }
  });
}

function loadToForm(){
  const selectedIndex = document.getElementById('existing_select').value;
  if(selectedIndex !== ''){
    const item = data[selectedIndex];
    document.getElementById('char_id').value = item.char_id || '';
    document.getElementById('attr_fisik').value = item.attr_fisik || '';
    document.getElementById('cloth_id').value = item.cloth_id || '';
    document.getElementById('voice_id').value = item.voice_id || '';
    document.getElementById('style_id').value = item.style_id || '';
    editIndex = selectedIndex;
  }
}

function loadData(){
  const xhr = new XMLHttpRequest();
  xhr.open('GET', GAS_URL + '?action=getData', true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);
          if (response.error) {
            alert('Error from GAS: ' + response.error);
            return;
          }
          data = response;
          renderList();
          updateExistingSelect();
          alert('Data berhasil dimuat dari Sheets! ğŸ“¥');
        } catch (e) {
          alert('Error parsing data: ' + e.message + ' - Response: ' + xhr.responseText);
        }
      } else {
        alert('Error loading data: ' + xhr.status + ' - ' + xhr.responseText);
      }
    }
  };
  xhr.send();
}

function renderList(){
  const list = document.getElementById('data_list');
  list.innerHTML = '';
  if(data.length === 0){
    list.innerHTML = '<p>Tidak ada data. Klik Load Data untuk muat dari Sheets.</p>';
    return;
  }
  data.forEach((item, index) => {
    list.innerHTML += `
      <div style="border-bottom: 1px solid #e5e7eb; padding: 8px 0;">
        <strong>ID Karakter:</strong> ${item.char_id || 'Kosong'} | 
        <strong>Atribut Fisik:</strong> ${item.attr_fisik || 'Kosong'} | 
        <strong>ID Pakaian:</strong> ${item.cloth_id || 'Kosong'} | 
        <strong>ID Suara:</strong> ${item.voice_id || 'Kosong'} | 
        <strong>ID Gaya:</strong> ${item.style_id || 'Kosong'}
        <button onclick="editData(${index})" style="margin-left: 10px; background: #22c55e; color: white; border: none; padding: 4px 8px; border-radius: 4px;">Edit</button>
        <button onclick="deleteData(${index})" style="margin-left: 5px; background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px;">Delete</button>
      </div>
    `;
  });
}

function addData(){
  const char_id = document.getElementById('char_id').value.trim();
  const attr_fisik = document.getElementById('attr_fisik').value.trim();
  const cloth_id = document.getElementById('cloth_id').value.trim();
  const voice_id = document.getElementById('voice_id').value.trim();
  const style_id = document.getElementById('style_id').value.trim();
  if(!char_id && !attr_fisik && !cloth_id && !voice_id && !style_id){
    alert('Isi setidaknya satu field!');
    return;
  }
  const xhr = new XMLHttpRequest();
  xhr.open('GET', GAS_URL + '?action=addData&char_id=' + encodeURIComponent(char_id) + '&attr_fisik=' + encodeURIComponent(attr_fisik) + '&cloth_id=' + encodeURIComponent(cloth_id) + '&voice_id=' + encodeURIComponent(voice_id) + '&style_id=' + encodeURIComponent(style_id), true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        alert(xhr.responseText);
        loadData(); // Reload setelah add
      } else {
        alert('Error adding data: ' + xhr.status + ' - ' + xhr.responseText);
      }
    }
  };
  xhr.send();
}

function updateData(){
  if(editIndex === -1){
    alert('Pilih data untuk edit dulu!');
    return;
  }
  const char_id = document.getElementById('char_id').value.trim();
  const attr_fisik = document.getElementById('attr_fisik').value.trim();
  const cloth_id = document.getElementById('cloth_id').value.trim();
  const voice_id = document.getElementById('voice_id').value.trim();
  const style_id = document.getElementById('style_id').value.trim();
  const xhr = new XMLHttpRequest();
  xhr.open('GET', GAS_URL + '?action=updateData&index=' + editIndex + '&char_id=' + encodeURIComponent(char_id) + '&attr_fisik=' + encodeURIComponent(attr_fisik) + '&cloth_id=' + encodeURIComponent(cloth_id) + '&voice_id=' + encodeURIComponent(voice_id) + '&style_id=' + encodeURIComponent(style_id), true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        alert(xhr.responseText);
        loadData();
        clearForm();
        editIndex = -1;
      } else {
        alert('Error updating data: ' + xhr.status + ' - ' + xhr.responseText);
      }
    }
  };
  xhr.send();
}

function deleteData(index){
  if(confirm('Yakin hapus data ini?')){
    const xhr = new XMLHttpRequest();
    xhr.open('GET', GAS_URL + '?action=deleteData&index=' + index, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          alert(xhr.responseText);
          loadData();
        } else {
          alert('Error deleting data: ' + xhr.status + ' - ' + xhr.responseText);
        }
      }
    };
    xhr.send();
  }
}

function editData(index){
  const item = data[index];
  document.getElementById('char_id').value = item.char_id || '';
  document.getElementById('attr_fisik').value = item.attr_fisik || '';
  document.getElementById('cloth_id').value = item.cloth_id || '';
  document.getElementById('voice_id').value = item.voice_id || '';
  document.getElementById('style_id').value = item.style_id || '';
  editIndex = index;
  document.getElementById('mode').value = 'edit';
  switchMode();
  document.getElementById('existing_select').value = index;
}

function clearForm(){
  ['char_id','attr_fisik','cloth_id','voice_id','style_id'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('existing_select').value = '';
  editIndex = -1;
  document.getElementById('mode').value = 'add';
  switchMode();
}
</script>
</body>
</html>
