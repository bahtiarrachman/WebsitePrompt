<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UGC Prompt Generator - Data KTP</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <span class="pill">ğŸ†” Data KTP Karakter</span>
      <h1>ğŸš€ Data KTP Karakter</h1>
      <p class="sub">Ini data KTP karakter yang akan digunakan untuk konsistensi video. Input data dulu di Manage Data sebelum generate prompt. Klik Copy untuk copy data KTP dalam bahasa Inggris (siap kirim ke TTV).</p>

      <!-- Arahan untuk TTV -->
      <div class="example">
        <strong>ğŸ’¡ Arahan untuk TTV</strong>
        Kirim data KTP ini ke TTV untuk konsistensi karakter di semua video. Pastikan karakter selalu menggunakan atribut fisik, pakaian, suara, dan gaya visual yang sama di setiap prompt.
      </div>

      <!-- List Data KTP (dalam English, default hidden) -->
      <div class="hr"></div>
      <label>ğŸ“‹ Data KTP dari Google Sheets (dalam Bahasa Inggris)</label>
      <div id="ktp_list" class="example" style="display: none;">
        <!-- Data akan muncul di sini -->
      </div>

      <div class="hr"></div>

      <div class="actions">
        <button class="btn" onclick="copyKTP()">ğŸ“‹ Copy Data KTP (English)</button>
        <button class="btn ghost" id="show_more_btn" onclick="toggleKTPList()">ğŸ‘ï¸ Show More</button>
        <button class="btn ghost" onclick="window.location.href='crud.html'">ğŸ—‚ï¸ Manage Data</button>
        <button class="btn alt" onclick="window.location.href='prompt_ttv.html'">âœ¨ Generate Prompt</button>
      </div>

      <p class="muted">Flow: Input data di Manage Data â†’ Copy KTP â†’ Generate Prompt â†’ Kirim ke TTV ğŸŒŸ</p>
    </div>
  </div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxdIpHkaifXYDS3Xs28xwLyp-fIoFYV-FJYaMeO_sP1x46NOviDziGFJ5CCFRUJMQks9Q/exec';

let ktpData = [];
let isDataLoaded = false;

function loadKTPData(){
  if (isDataLoaded) return; // Hindari load ulang
  const list = document.getElementById('ktp_list');
  list.innerHTML = '<p>Loading data KTP...</p>';
  list.style.display = 'block'; // Tampilkan saat loading
  const xhr = new XMLHttpRequest();
  xhr.open('POST', GAS_URL, true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        try {
          console.log('Response:', xhr.responseText); // Tambah logging
          const response = JSON.parse(xhr.responseText);
          if (response.error) {
            list.innerHTML = '<p>Error loading data: ' + response.error + '</p>';
            return;
          }
          // Parse sebagai array of arrays
          ktpData = response.map(row => ({
            char_id: row[0] || 'Empty',
            attr_fisik: row[1] || 'Empty',
            cloth_id: row[2] || 'Empty',
            voice_id: row[3] || 'Empty',
            style_id: row[4] || 'Empty'
          }));
          console.log('Parsed data:', ktpData); // Tambah logging
          renderKTPList();
          isDataLoaded = true;
        } catch (e) {
          list.innerHTML = '<p>Error parsing data: ' + e.message + '</p>';
          console.error('Parse error:', e); // Tambah logging
        }
      } else {
        list.innerHTML = '<p>Error loading data: ' + xhr.status + '</p>';
        console.error('HTTP error:', xhr.status, xhr.responseText); // Tambah logging
      }
    }
  };
  xhr.send('action=getData');
}

function renderKTPList(){
  const list = document.getElementById('ktp_list');
  list.innerHTML = '';
  if(ktpData.length === 0){
    list.innerHTML = '<p>Tidak ada data KTP. Klik Manage Data untuk input dulu.</p>';
    return;
  }
  ktpData.forEach((item, index) => {
    list.innerHTML += `
      <div style="border-bottom: 1px solid #e5e7eb; padding: 8px 0;">
        <strong>Character ID:</strong> ${item.char_id}<br/>
        <strong>Physical Attributes:</strong> ${item.attr_fisik}<br/>
        <strong>Clothing:</strong> ${item.cloth_id}<br/>
        <strong>Voice:</strong> ${item.voice_id}<br/>
        <strong>Visual Style:</strong> ${item.style_id}
      </div>
    `;
  });
  list.style.display = 'none'; // Hide setelah render
}

function toggleKTPList(){
  const list = document.getElementById('ktp_list');
  const btn = document.getElementById('show_more_btn');
  if (list.style.display === 'none') {
    list.style.display = 'block';
    btn.textContent = 'ğŸ™ˆ Hide';
  } else {
    list.style.display = 'none';
    btn.textContent = 'ğŸ‘ï¸ Show More';
  }
}

function copyKTP(){
  if (!isDataLoaded || ktpData.length === 0) {
    alert('Data belum dimuat. Tunggu loading selesai atau refresh halaman.');
    return;
  }
  let text = 'Character KTP Data (for TTV consistency):\n';
  ktpData.forEach((item, index) => {
    text += `\nCharacter ID: ${item.char_id}\n`;
    text += `Physical Attributes: ${item.attr_fisik}\n`;
    text += `Clothing: ${item.cloth_id}\n`;
    text += `Voice: ${item.voice_id}\n`;
    text += `Visual Style: ${item.style_id}\n`;
  });
  navigator.clipboard.writeText(text).then(() => {
    alert('Data KTP berhasil dicopy dalam bahasa Inggris! ğŸ“‹');
  }).catch(err => {
    alert('Gagal copy: ' + err);
  });
}

// Auto load data saat halaman buka (sekali saja)
window.onload = function() {
  loadKTPData();
};
</script>
</body>
</html>
